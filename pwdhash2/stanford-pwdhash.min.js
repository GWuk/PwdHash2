const SPH_kPasswordKey="DOM_VK_F2";const SPH_kPasswordPrefix="@@";const SPH_kMinimumPasswordSize=5;const SPH_AddOnName="PwdHash";var SPH_debug=true;function SPH_dump(a){if(SPH_debug)console.log(SPH_AddOnName+": "+a)}function SPH_PasswordKeyMonitor(){this.keystream=new Array();window.addEventListener("keydown",this,true);window.addEventListener("keypress",this,true);window.addEventListener("keyup",this,true)}SPH_PasswordKeyMonitor.prototype={keystream:null,protector:null,handleEvent:function(a){if(a.keyCode==a[SPH_kPasswordKey]){a.stopPropagation();a.preventDefault();if(a.type=="keydown"){a.pwdkey=true;if(a.shiftKey){SPH_legacyUser=true SPH_legacy=true;SPH_dump("enabled legacy mode");SPH_controller.warnUser(SPH_strings["pwdhash.legacy"])}if(this.attemptPasswordKeyLogin()){SPH_dump("enabled pwdhash on field '"+a.target.name+"'")}else{SPH_dump("failed to get pwd field")}}}if(a.type=="keypress"){var b=String.fromCharCode(a.charCode);this.keystream.push(b);if(this.keystream.length>SPH_kPasswordPrefix.length)this.keystream.shift();if(!this.protector&&this.keystream.join('')==SPH_kPasswordPrefix){a.alreadyIntercepted=true;this.attemptPasswordPrefixLogin(b)}}},attemptPasswordKeyLogin:function(){if(this.protector){this.protector.field.value="";return this.protector}try{var a=document.activeElement;if(a){if(a.nodeName=="INPUT"&&a.type=="password"){a.value="";return new SPH_PasswordProtector(a,this)}}}catch(e){SPH_dump(e.message)}try{var b=document.getElementById('content').selectedBrowser.contentWindow;var c=this.findPasswordField(b);if(c){c.focus();return new SPH_PasswordProtector(c,this)}}catch(e){SPH_dump(e.message)}try{var d=document.getElementsByTagName('INPUT');for(var i=0;i<d.length;i++)if(d[i].type=="password")return new SPH_PasswordProtector(d[i],this)}catch(e){SPH_dump(e.message)}var f=SPH_strings["pwdhash.pwdkeywarn"];SPH_controller.warnUser(f);return null},attemptPasswordPrefixLogin:function(a){if(this.protector){return this.protector}try{var b=document.activeElement;if(b){if(b.nodeName=="INPUT"&&b.type=="password"){if(b.value+a==SPH_kPasswordPrefix){return new SPH_PasswordProtector(b,this)}}}}catch(e){SPH_dump(e.message)}var c=SPH_strings["pwdhash.pwdprefixwarn"];SPH_controller.warnUser(c);return null},findPasswordField:function(a){var b=a.document.getElementsByTagName('INPUT');for(var i=0;i<b.length;i++)if(b[i].type=="password")return b[i];var c=null;if(a.frames)for(var i=0;i<a.frames.length;i++)if(!c)c=this.findPasswordField(a.frames[i]);return c},}function SPH_PasswordProtector(a,b){if(!SPH_legacy&&(SPH_salt=="")){SPH_controller.warnUser(SPH_strings["pwdhash.saltempty"]);a.value=""return null}this.keyMap=new Array();this.nextAvail=this.firstAvail;this.field=a;this.field.setAttribute("secure","yes");this.borderstyle=this.field.style.border;this.field.style.border="2px dashed "+(SPH_legacy?"red":"green");window.addEventListener("keydown",this,true);window.addEventListener("keyup",this,true);window.addEventListener("keypress",this,true);window.addEventListener("blur",this,true);window.addEventListener("focus",this,true);window.addEventListener("submit",this,true);b.protector=this;this._disable=function(){window.removeEventListener("keydown",this,true);window.removeEventListener("keyup",this,true);window.removeEventListener("keypress",this,true);window.removeEventListener("blur",this,true);window.removeEventListener("focus",this,true);window.removeEventListener("submit",this,true);b.protector=null}}SPH_PasswordProtector.prototype={firstAvail:'A'.charCodeAt(0),lastAvail:127,nextAvail:null,keyMap:null,field:null,borderstyle:null,handleEvent:function(a){if(!a.pwdkey&&a.originalTarget!=this.field&&a.originalTarget!=this.field.form){SPH_dump('Unexpected event '+a.type+' on target '+a.originalTarget);this._disable()}if(a.alreadyIntercepted)return;if((a.type=="keydown"||a.type=="keyup")&&a.keyCode>=a.DOM_VK_0&&a.keyCode<=a.DOM_VK_DIVIDE){a.stopPropagation()}if(a.type=="keypress"&&a.keyCode==0){a.stopPropagation();a.preventDefault();a.originalTarget.value=a.originalTarget.value+String.fromCharCode(this.mask(a.charCode))}if(a.type=="blur"||a.type=="submit"){this.finish()}},_warnUntrusted:function(){this._disable();if(this.field)this.field.value='';var a=SPH_strings["pwdhash.trustedeventwarn"];SPH_dump(a)},getPasswordFromMasked:function(a){var b="";for(var i=0;i<a.length;i++){var c=a.charCodeAt(i);if(this.keyMap[c])b+=String.fromCharCode(this.keyMap[c]);else b+=a.substring(i,1)}return b},mask:function(a){this.keyMap[this.nextAvail]=a;if(this.nextAvail>this.lastAvail){var b=SPH_strings["pwdhash.longpasswordwarn"];SPH_controller.warnUser(b);this._disable()}return this.nextAvail++},finish:function(){this._disable();var a=this.field var b=a.value;if(b==""){a.secure=undefined}else{var c=SPH_kPasswordPrefix.length;if(b.substring(0,c)==SPH_kPasswordPrefix)b=b.substring(c);if(b.length<SPH_kMinimumPasswordSize){var d=SPH_strings["pwdhash.shortpasswordwarn"];SPH_controller.warnUser(d);a.value=''}else{var e=new String(a.ownerDocument.location);var f=(new SPH_DomainExtractor()).extractDomain(e);var g=this.getPasswordFromMasked(b);if(SPH_legacy){a.value=(new SPH_HashedPassword_MD5(g,f))}else{a.value=(new SPH_HashedPassword(g,f,SPH_salt,SPH_iterations))}var h=function(){a.removeEventListener("keydown",h,false);a.removeEventListener("focus",h,false);a.value=""}a.addEventListener("keydown",h,false);a.addEventListener("focus",h,false)}}this.field.style.border=this.borderstyle;SPH_legacyUser=false},}function SPH_Controller(a){this._passwordKeyMonitor=new SPH_PasswordKeyMonitor()}SPH_Controller.prototype={warnUser:function(a){alert(SPH_AddOnName+": "+a)},}var SPH_controller;var SPH_strings;var SPH_salt="";var SPH_iterations;var SPH_legacy=true;var SPH_strings={};var SPH_legacyUser=false function SPH_getOptions(){function onError(a){SPH_dump("Error: ${error}")}function onGot(a){SPH_salt=a.salt;SPH_iterations=a.iterations;if(!SPH_legacyUser)SPH_legacy=(a.legacy==null?true:a.legacy)if(SPH_legacy)SPH_dump("legacy = "+SPH_legacy)}return browser.storage.local.get().then(onGot,onError)}function SPH_init(){SPH_controller=new SPH_Controller();SPH_strings["pwdhash.pwddisplay"]="Hashed password for %s: %s";SPH_strings["pwdhash.warningtitle"]="PwdHash Warning";SPH_strings["pwdhash.pwdkeywarn"]="PwdHash could not find a password field on this page.\nIt is possible, though unlikely, that the site trying to steal your password.\nDo not enter your PwdHash password into this page.";SPH_strings["pwdhash.pwdprefixwarn"]="You typed the PwdHash password prefix, but you are not currently in a password field that starts with the password prefix.\nIt is possible, though unlikely, that the site trying to steal your password.\nDo not enter your PwdHash password into this page.";SPH_strings["pwdhash.trustedeventwarn"]="JavaScript on this page may be interfering with your ability to enter a password.\nAs a precaution, the password field has been cleared.\nIf the problem persists, you might not be able to use PwdHash on this page.";SPH_strings["pwdhash.longpasswordwarn"]="Your password is too long to protect.";SPH_strings["pwdhash.shortpasswordwarn"]="Your password is too short to protect.";SPH_strings["pwdhash.saltempty"]="No salt set, you have to set one in Add-On options.";SPH_strings["pwdhash.legacy"]="Legacy mode enabled manually, reload page to use mode configured in options"}